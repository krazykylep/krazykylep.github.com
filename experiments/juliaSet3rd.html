<!DOCTYPE html>
<html>
<head>
<title>Julia Set Generator</title>
<script type="text/javascript">
var canvas;
var canvas2;
var ctx;
var ctx2;

var canvasXY;
var mousePt;

var width;
var height;
var xmin;
var xmax;
var ymin;
var ymax;
var iterations;
var cutOffDist;
var cutOffDistSquared;
var colors;

var initX;
var initY;
	
var xaxis;
var yaxis;
var date;
var renderStartTime;

var ctrlDown = false;

function toDraw(a){
	if(a == 1){
		initX = document.getElementById('zx').value - 0;
		initY = document.getElementById('zy').value - 0;
		document.getElementById('initz').innerHTML = "This set used the complex number "+initX+" + "+initY+"i";
	}
	document.getElementById('loading').innerHTML = "Loading...";
	date = new Date();
	renderStartTime = date.getTime();
	setTimeout('draw()', '1');
}

function draw(){
	width = document.getElementById('cwid').value - 0;
	height = document.getElementById('chei').value - 0;
	xmin = document.getElementById('xmin').value - 0;
	xmax = document.getElementById('xmax').value - 0;
	ymin = document.getElementById('ymin').value - 0;
	ymax = document.getElementById('ymax').value - 0;
	iterations = document.getElementById('iter').value - 0;
	cutOffDist = document.getElementById('dist').value - 0;
	cutOffDistSquared = cutOffDist * cutOffDist;
	colors = document.getElementById('colors').checked;
	
	//initX = document.getElementById('zx').value - 0;
	//initY = document.getElementById('zy').value - 0;
	
	xaxis = xmax - xmin;
	yaxis = ymax - ymin;
	
	canvas = document.getElementById('canvas');
	ctx = canvas.getContext('2d');
	canvas2 = document.getElementById('canvasPre');
	ctx2 = canvas2.getContext('2d');
	
	clearCanvas();
	
	for(var y=0; y<height; ++y){
		for(var x=0; x<width; ++x){
	
			var x0 = x * xaxis / width + xmin;
			var y0 = y * yaxis / height + ymin;
			
			x1 = x0;
			y1 = y0;
			z = 0;
			
			while((x1*x1 + y1*y1) <= cutOffDistSquared && z < iterations ){
				xtemp = x1*x1*x1 - 3*x1*y1*y1 + initX;
				y1 = 3*x1*x1*y1-y1*y1*y1 + initY;
				x1 = xtemp;
				++z;
			}
			
			if(z == iterations){
				ctx.fillStyle = 'black';
				ctx.fillRect(x,y,1,1);
			}else if(colors){
				
				//crazy stuff...
				var red = Math.floor(Math.abs((30*x1*y1/Math.sin(z))%255));
				var green = Math.floor(Math.abs((30*x1*x1/Math.cos(z))%255));
				var blue = Math.floor(Math.abs((30*y1*y1/Math.tan(z))%255));
				
				
				//smooth shading
				//var red = 255-Math.floor((z/iterations)*255);
				//var green = red;
				//var blue = red;
				
				ctx.fillStyle = 'rgb('+red+','+green+','+blue+')';
				ctx.fillRect(x,y,1,1);
			}
		}
	}
	
	var showZ = document.getElementById('showZ').checked;
	var showA = document.getElementById('showAxis').checked;
	
	if(showZ){
		ctx.fillStyle = 'red';
		ctx.fillRect(((initX - xmin) * width / xaxis)-1, ((initY - ymin) * height / yaxis)-1, 3, 3);
	}
	if(showA){
		ctx.fillStyle = 'red';
		ctx.fillRect(((0 - xmin) * width / xaxis), 0, 1, height);
		ctx.fillRect(0, ((0 - ymin) * height / yaxis), width, 1);
	}
	
	date = new Date();
	document.getElementById('loading').innerHTML = "Render Time: "+((date.getTime() - renderStartTime)/1000.0)+" seconds";
}

function clearCanvas(){
	//Have to do it this way because the canvas only understands its height and 
	//width from the attributes in the tag... so no style.width setting.
	var newWidth = document.getElementById('cwid').value;
	var newHeight = document.getElementById('chei').value;
	canvas.width = newWidth;
	canvas.height = newHeight;
	ctx.fillStyle = 'white';
	ctx.fillRect(0,0,newWidth,newHeight);
	canvasXY = getpos(canvas);
}

function mouseDown(e){
	if(e.which == 3){
		return false;
	}
	
	var x = e.pageX;
	var y = e.pageY;
	x -= canvasXY.x;
	y -= canvasXY.y;
	mousePt = {x:x, y:y};
}

function mouseMove(e){
	previewCanvas(e);
}

function mouseUp(e){
	if(e.which == 3){
		return false;
	}
	var x = e.pageX;
	var y = e.pageY;
	x -= canvasXY.x;
	y -= canvasXY.y;
	
	var pt1x = mousePt.x * xaxis / width + xmin;
	var pt1y = mousePt.y * yaxis / height + ymin;
	var pt2x = x * xaxis / width + xmin;
	var pt2y = y * yaxis / height + ymin;
	
	var xminObj = document.getElementById('xmin');
	var xmaxObj = document.getElementById('xmax');
	var yminObj = document.getElementById('ymin');
	var ymaxObj = document.getElementById('ymax');
	var initZx = document.getElementById('zx');
	var initZy = document.getElementById('zy');
	
	if(mousePt.x == x && mousePt.y == y){
		//mouse was clicked but not dragged.
		if(ctrlDown){
			initZx.value = pt1x;
			initZy.value = pt1y;
		}else{
			var midPtx = (xmax + xmin)/2;
			var midPty = (ymax + ymin)/2;
			var xptDif = pt1x - midPtx;
			var yptDif = pt1y - midPty;
		
			xminObj.value = (xminObj.value - 0) + xptDif;
			xmaxObj.value = (xmaxObj.value - 0) + xptDif;
			yminObj.value = (yminObj.value - 0) + yptDif;
			ymaxObj.value = (ymaxObj.value - 0) + yptDif;
		}
	}else{
		//determine how mouse was dragged...
		if(mousePt.x < x && mousePt.y < y){
			//first pt is north west of second.
			xminObj.value = pt1x;
			xmaxObj.value = pt2x;
			yminObj.value = pt1y;
			ymaxObj.value = pt2y;
		}else if(mousePt.x < x && mousePt.y > y){
			//first pt is south west of second.
			xminObj.value = pt1x;
			xmaxObj.value = pt2x;
			yminObj.value = pt2y;
			ymaxObj.value = pt1y;
		}else if(mousePt.x > x && mousePt.y < y){
			//first pt is north east of second.
			xminObj.value = pt2x;
			xmaxObj.value = pt1x;
			yminObj.value = pt1y;
			ymaxObj.value = pt2y;
		}else{
			//first pt is south east of second.
			xminObj.value = pt2x;
			xmaxObj.value = pt1x;
			yminObj.value = pt2y;
			ymaxObj.value = pt1y;
		}
	}

	clearCanvas();
	toDraw(ctrlDown);
}

function previewCanvas(e){
	if(document.getElementById('showGuide').checked){
		var widthP = 100;
		var heightP = 75;
		var itersP = 40;
		
		ctx2.fillStyle = 'white';
		ctx2.fillRect(0,0,widthP,heightP);
		ctx2.fillStyle = 'black';
		
		var ptx = (e.pageX - canvasXY.x) * xaxis / width + xmin;
		var pty = (e.pageY - canvasXY.y) * yaxis / height + ymin;

		for(var y=0; y<heightP; ++y){
			for(var x=0; x<widthP; ++x){
				var x1 = x * xaxis / widthP + xmin;
				var y1 = y * yaxis / heightP + ymin;
				
				z = 0;
				
				while((x1*x1 + y1*y1) <= 3 && z < itersP ){
					xtemp = x1*x1*x1 - 3*x1*y1*y1 + ptx;
					y1 = 3*x1*x1*y1-y1*y1*y1 + pty;
					x1 = xtemp;
					++z;
				}
				
				if(z == itersP){
					ctx2.fillRect(x,y,1,1);
				}
			}
		}
	}
}

function getpos(o) {
	return { x:o.offsetLeft, y:o.offsetTop }
}

function resetDefaults(){
	document.getElementById('cwid').value = '400';
	document.getElementById('chei').value = '300';
	document.getElementById('xmin').value = '-2.0';
	document.getElementById('xmax').value = '2.0';
	document.getElementById('ymin').value = '-1.5';
	document.getElementById('ymax').value = '1.5';
	document.getElementById('iter').value = '50';
	document.getElementById('dist').value = '2.0';
	document.getElementById('colors').checked = false;
}

function resetZ(){
	document.getElementById('zx').value = '-1.0';
	document.getElementById('zy').value = '0.25';
}

function saveImage(){
	var data = canvas.toDataURL("image/png");
	var img = document.createElement("img");
	img.src = data;
   
	var output = document.getElementById('imageDiv');
	while (output.hasChildNodes()){
		output.removeChild(output.firstChild);
	}
	output.appendChild(img);
	window.location.hash="ss";
}

document.onkeydown = function(event){
     var holder;
     //IE uses this
     if(window.event){
            holder=window.event.keyCode;
     }
     //FF uses this
     else{
            holder=event.which;
     } 
     keydown(holder);
}

function keydown(key){
	 if(key == 17){
            ctrlDown = true;
     }
}

document.onkeyup = function(event){
     var holder;
     //IE uses this
     if(window.event){
            holder=window.event.keyCode;
     }
     //FF uses this
     else{
            holder=event.which;
     } 
     keyup(holder);
}

function keyup(key){
     if(key == 17){
            ctrlDown = false;
     }
}


</script>

</head>

<body onload="toDraw(1);">
	<a href="../experiments.html"><-- Back</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="juliaSet.html">Julia Set --></a>
	<h1>Julia Set Generator</h1>
	<h3>Works best in Google Chrome.</h3>
	<b>Instructions:</b><br/>
	<ul>
	<li>Modify any of the numbers and click generate</li>
	<li>Keep all numbers lowish, or you will have to wait a LONG time.</li>
	<li>Click and Drag anywhere in the canvas to specify a new window area and it will automatically zoom to it.</li>
	<li>Click in one spot to define a new center point for the canvas to move to.</li>
	<li>Ctrl+Click in one spot to define a new initial complex point that will render something like in the preview.</li>
	</ul>
	<div style="float: left;">
	<table>
		<tr><td>
		Canvas Width:
		</td><td>
		<input type="text" id="cwid" value="400" />
		</td><td>
		Xmin:
		</td><td>
		<input type="text" id="xmin" value="-2.0" />
		</td></tr>
		<tr><td>
		Canvas Height:
		</td><td>
		<input type="text" id="chei" value="300" />
		</td><td>
		Xmax:
		</td><td>
		<input type="text" id="xmax" value="2.0" />
		</td></tr>
		<tr><td>
		Iterations:
		</td><td>
		<input type="text" id="iter" value="50" />
		</td><td>
		Ymin:
		</td><td>
		<input type="text" id="ymin" value="-1.5" />
		</td></tr>
		<tr><td>
		Cut Off Dist:
		</td><td>
		<input type="text" id="dist" value="2.0" />
		</td><td>
		Ymax:
		</td><td>
		<input type="text" id="ymax" value="1.5" />
		</td></tr>
		<tr><td>
		Initial Z:
		</td><td>
		<input type="text" id="zx" value="0.0" />
		</td><td>
		+
		</td><td>
		<input type="text" id="zy" value="-1.0" />i
		</td></tr>
	</table>
	</div>
	<div style="float: left; margin-left: 30px;">
		Canvas Preview:<br/>
		<canvas id="canvasPre" width="100" height="75" style="border: 1px solid #000000;"></canvas>
	</div>
	<div style="clear: both;">
	<input type="button" value="Generate" onclick="toDraw(1);" />
	<input type="button" value="Reset Graph Defaults" onclick="resetDefaults();" />
	<input type="button" value="Reset Z" onclick="resetZ();" />
	<input type="button" value="Save Image" onclick="saveImage();" />
	<span id="loading"></span><br/>
	
	Colors: <input type="checkbox" id="colors" value="1" /> 
	Show Z on Graph: <input type="checkbox" id="showZ" value="1" /> 
	Show Axis:	<input type="checkbox" id="showAxis" value="1" /> 
	Show Preview: <input type="checkbox" id="showGuide" value="1" checked="checked" /> 
	<br/><br/>
	<div id="canvasDiv">
		<canvas id="canvas" onmouseup="mouseUp(event);" onmousedown="mouseDown(event);" onmousemove="mouseMove(event)";></canvas>
	</div>
	<div id="initz"></div>
	<span>If there is an image below here, right click on it to save it.</span>
	<div id="imageDiv"></div>
	<a name="ss"></a>
	</div>
</body>
</html>
