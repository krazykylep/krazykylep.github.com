<!DOCTYPE html>
<html>
<head>
<title>B&eacute;zier Curves</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script type="text/javascript">
var canvas;
var ctx;
var canvasXY;
var cwid;
var chei;

var mouseDown = false;
var mouseDragging = false;
var mousePt = {};

var ctrlDown = false;

var curves = Array();
var showCtrl = true;
var activeCtrl = false;
var selCurve;
var selCtrlPt;
var step = 0.03333333;

function init(){
  canvas = $("#canvas");
  
  cwid = $("#cwid").val();
  chei = $("#chei").val();
  
  canvas.mousedown(function(e){
    mouseDown = true;
    var x = e.pageX;
    var y = e.pageY;
    x -= canvasXY.x;
    y -= canvasXY.y;
    
    mousePt.x = x;
    mousePt.y = y;
    
    if(showCtrl){
      if(checkForCtrlPt(x,y)){
        drawCurves();
      }
    }else{
      selCtrlPt = undefined
    }
  });
  
  canvas.mousemove(function(e){
    if(!mouseDown){
      return false;
    }
    mouseDragging = true;
    var x = e.pageX;
    var y = e.pageY;
    x -= canvasXY.x;
    y -= canvasXY.y;
    
    if(selCtrlPt !== undefined){
      selCtrlPt.x = x;
      selCtrlPt.y = y;
      drawCurves();
    }else{
      if(!ctrlDown){
        var newCurve = new Curve(mousePt.x,mousePt.y,x,y);
        curves.push(newCurve);
        selCurve = newCurve;
        selCtrlPt = newCurve.ctrlPoints[1];
      }
    }
  });
  
  $(window).mouseup(function(e){
    mouseDown = false;
    var x = e.pageX;
    var y = e.pageY;
    x -= canvasXY.x;
    y -= canvasXY.y;
    
    if(ctrlDown){
      if(selCtrlPt === undefined){
        selCurve.addPoint(mousePt.x, mousePt.y);
      }else{
        selCurve.delCtrlPt(selCtrlPt);
        selCtrlPt = undefined;
      }
    }
    
    drawCurves();
    mouseDragging = false;
  });
  
  $("#clearbtn").click(resetEverything);
  
  $("#apply").click(changeCanvas);
  
  $("#showCtrl").click(function(){
    showCtrl = !showCtrl;
    drawCurves();
  });
  
  $("#activeCtrl").click(function(){
    activeCtrl = !activeCtrl;
    drawCurves();
  });
  
  canvasXY = getpos(canvas);
  
  $("#canvasDiv").css("width", cwid);
  $("#canvasDiv").css("height", chei);
  canvas.attr("width", cwid);
  canvas.attr("height", chei);
  
  ctx = canvas.get(0).getContext('2d');
}

function checkForCtrlPt(x,y){
  for(c in curves){
    if(activeCtrl && curves[c] != selCurve){
      continue;
    }
    for(p in curves[c].ctrlPoints){
      if(isClickingPt(x,y,curves[c].ctrlPoints[p])){
        selCtrlPt = curves[c].ctrlPoints[p];
        selCurve = curves[c];
        return true;
      }
    }
  }
  selCtrlPt = undefined;
  return false;
}

function isClickingPt(x,y,pt){
  var xdiff = x - pt.x;
  var ydiff = y - pt.y;
  if((xdiff*xdiff+ydiff*ydiff) < 25){
    return true;
  }
  return false;
}

function drawCurves(){
  clearCanvas();
  for(c in curves){
    curves[c].draw();
  }
}

function CtrlPoint(x,y){
  this.x = x;
  this.y = y;
}

CtrlPoint.prototype.draw = function(selected){
  if(selected === undefined || selected === false){
    ctx.fillStyle = "#DDDDDD";
  }else{
    ctx.fillStyle = "#8ED6FF";
  }
  drawCircle(this.x,this.y,5);
};

function drawCircle(x,y,rad,stroke){
  if(stroke === undefined){
    stroke = true;
  }
  ctx.beginPath();
  ctx.arc(x, y, rad, 0, 2 * Math.PI, false);
  ctx.fill();
  if(stroke){
    ctx.strokeStyle = "black";
    ctx.stroke();
  }
}

function Curve(startx, starty, endx, endy){
  this.startx = startx;
  this.starty = starty;
  this.endx = endx;
  this.endy = endy;
  
  this.ctrlPoints = [new CtrlPoint(startx,starty), new CtrlPoint(endx,endy)];
}

Curve.prototype.addPoint = function(x,y){
  this.ctrlPoints.push(new CtrlPoint(x,y));
};

Curve.prototype.draw = function(){
  var n = this.ctrlPoints.length-1;
  var binoms = pascal_row(n);
  if(showCtrl){
    if((activeCtrl && selCurve == this) || !activeCtrl){
      this.drawCtrlPoints((this == selCurve));
    }
  }
  ctx.beginPath();
  ctx.moveTo(this.ctrlPoints[0].x, this.ctrlPoints[0].y);
  for(var t=step; t<=1; t=truncate(t+step)){
    var ptx = 0;
    var pty = 0;
    for(var i=0; i<n+1; ++i){
      var coef = binoms[i]*Math.pow(1-t, n-i)*Math.pow(t, i);
      ptx += this.ctrlPoints[i].x*coef;
      pty += this.ctrlPoints[i].y*coef;
    }
    ctx.lineTo(ptx, pty);
  }
  ctx.stroke();
};

Curve.prototype.drawCtrlPoints = function(selected){
  for(p in this.ctrlPoints){
    this.ctrlPoints[p].draw(selected);
  }
};

Curve.prototype.delete = function(){
  for(c in curves){
    if(curves[c] == this){
      curves.splice(c,1);
      break;
    }
  }
  selCurve = curves[curves.length-1];
  drawCurves();
};

Curve.prototype.delCtrlPt = function(ctrlPt){
  for(pt in this.ctrlPoints){
    if(this.ctrlPoints[pt] == ctrlPt){
      this.ctrlPoints.splice(pt, 1);
      break;
    }
  }
  if(this.ctrlPoints.length == 1){
    this.delete();
  }
};

function pascal_row(n){
	var c_max = n+1;
	var ans = Array(c_max);
	ans[0] = 1;
	for(var x = 1; x<c_max; ++x){
		ans[x] = ans[x-1] * (c_max-x)/x;
	}
	return ans;
}

function randInt(low, high){
  return Math.floor(Math.random()*(high-low+1))+low;
}

var changeCanvas = function(){
  cwid = $("#cwid").val();
  chei = $("#chei").val();
  
  $("#canvasDiv").css("width", cwid);
  $("#canvasDiv").css("height", chei);
  canvas.attr("width", cwid);
  canvas.attr("height", chei);
  
  step = 1/$("#step").val();
  
  drawCurves();
}

var resetEverything = function(){
  clearCanvas();
  curves = Array();
}

function clearCanvas(){
  ctx.fillStyle = 'white';
  ctx.fillRect(0,0,cwid,chei);
}

var importJSON = function(){
  if($("#inout").val() != ""){
    var im = JSON.parse($("#inout").val());
    
    $("#cwid").val(im.cwid);
    $("#chei").val(im.chei);
    changeCanvas();
  }
}

//this function exists because javascript has problems with adding many floats together.
function truncate(x){
  return Math.floor(100000000*x)/100000000;
}

function getpos(o) {
	return { x:o.offset().left, y:o.offset().top };
}

document.onkeydown = function(event){
  var key_code;
  if(window.event){
    //IE uses this
    key_code=window.event.keyCode;
  }else{
    //FF uses this
    key_code=event.which;
  }

  if(key_code == 17){
    //ctrl key
    ctrlDown = true;
  }else if(key_code == 46){
    //delete key
    if(selCurve != undefined){
      selCurve.delete();
    }
  }
}

document.onkeyup = function(event){
  var key_code;
  if(window.event){
    //IE uses this
    key_code=window.event.keyCode;
  }else{
    //FF uses this
    key_code=event.which;
  }
  if(key_code == 17){
    ctrlDown = false;
  }
}

</script>

</head>

<body onload="init()">
  <a href="../experiments.html"><-- Back</a>
	<h1>B&eacute;zier Curves</h1>
	<h3>Works best in Firefox or Google Chrome.</h3>
	<b>Instructions:</b><br/>
	<ul>
	<li>Click and drag to draw a line.</li>
  <li>Click and drag circles to move control points.</li>
  <li>Hold control and click on a white area to add a new control point.</li>
  <li>Hold control and click on a control point to delete it.</li>
  <li>Press the delete key to delete the selected line.</li>
	</ul>
	<div style="float: left;">
	<table>
		<tr><td>
		Canvas Height:
		</td><td>
		<input type="text" id="chei" value="450" />
		</td></tr>
		<tr><td>
		Canvas Width:
		</td><td>
		<input type="text" id="cwid" value="800" />
    </td></tr>
    <tr><td>
		Bezier Iters:
		</td><td>
		<input type="text" id="step" value="30" />
		</td></tr>
  </table>
  <input type="button" value="Apply Settings &amp; Redraw" id="apply" />
  <input type="button" value="Clear Canvas" id="clearbtn" />
  Show Control Points: <input type="checkbox" id="showCtrl" checked="checked" />
  Only Show Active: <input type="checkbox" id="activeCtrl" />
	</div>
	<div style="clear: both; padding-top: 20px;">
    <div id="canvasDiv" style="border: 1px solid #000;">
      <canvas id="canvas"></canvas>
    </div>
  </div>
</body>
</html>
